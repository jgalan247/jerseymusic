{% extends 'base.html' %}
{% load static %}

{% block title %}Payment Widget - Jersey Events{% endblock %}

{% block extra_head %}
<!-- Remove X-Frame-Options meta tag as it's handled by Django decorator -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Content Security Policy for SumUp widget -->
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://gateway.sumup.com https://api.sumup.com https://checkout.sumup.com;
    frame-src 'self' https://gateway.sumup.com https://checkout.sumup.com;
    connect-src 'self' https://api.sumup.com https://gateway.sumup.com;
    style-src 'self' 'unsafe-inline' https://gateway.sumup.com;
">

<style>
    .widget-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }

    .payment-widget-card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin: 20px 0;
    }

    #sumup-card {
        min-height: 400px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        background: #f9fafb;
    }

    .order-summary {
        background: #f3f4f6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .security-info {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .security-badge {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.875rem;
        color: #059669;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
    }

    .success-message {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #16a34a;
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="widget-container">
        <div class="payment-widget-card">
            <h2 class="text-center mb-4">
                <i class="fas fa-credit-card me-2"></i>Secure Payment
            </h2>

            {% if order %}
            <!-- Order Summary -->
            <div class="order-summary">
                <h5><i class="fas fa-shopping-cart me-2"></i>Order Summary</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span>Order Number:</span>
                    <strong>{{ order.order_number }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Items:</span>
                    <span>{{ order.items.count }} ticket(s)</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Total:</span>
                    <strong class="text-primary">¬£{{ order.total }}</strong>
                </div>
            </div>
            {% endif %}

            <!-- Widget Loading Status -->
            <div id="widget-status" class="text-center mb-3">
                <div class="loading-spinner me-2"></div>
                <span>Loading secure payment form...</span>
            </div>

            <!-- SumUp Widget Container -->
            <div id="sumup-card" style="display: none;">
                <!-- SumUp widget will be mounted here -->
            </div>

            <!-- Error Container -->
            <div id="error-container" style="display: none;"></div>

            <!-- Security Information -->
            <div class="security-info">
                <div class="security-badge">
                    <i class="fas fa-lock"></i>
                    <span>256-bit SSL</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>PCI Compliant</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-certificate"></i>
                    <span>Secure Processing</span>
                </div>
            </div>

            <div class="text-center mt-3">
                <small class="text-muted">
                    Powered by <strong>SumUp</strong> - Trusted payment processing
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SumUp Widget SDK -->
<script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß SumUp Widget Initialization Starting...');

    const widgetContainer = document.getElementById('sumup-card');
    const statusContainer = document.getElementById('widget-status');
    const errorContainer = document.getElementById('error-container');

    // Check if SumUp SDK loaded
    if (typeof SumUpCard === 'undefined') {
        console.error('‚ùå SumUp SDK failed to load');
        showError('Payment system unavailable. Please try again later.');
        return;
    }

    console.log('‚úÖ SumUp SDK loaded successfully');

    {% if checkout_id %}
    // Initialize SumUp widget
    try {
        console.log('üöÄ Mounting SumUp widget with checkout ID: {{ checkout_id }}');

        SumUpCard.mount({
            id: 'sumup-card',
            checkoutId: '{{ checkout_id }}',
            onResponse: function(type, body) {
                console.log('üìù SumUp Response:', type, body);

                if (type === 'success') {
                    console.log('‚úÖ Payment successful!');
                    showSuccess('Payment completed successfully! Redirecting...');

                    // Redirect to success page
                    setTimeout(function() {
                        window.location.href = '/payments/success/?order={{ order.order_number if order else "" }}';
                    }, 2000);

                } else if (type === 'error') {
                    console.error('‚ùå Payment error:', body);
                    showError('Payment failed: ' + (body.message || 'Unknown error'));

                } else if (type === 'cancel') {
                    console.log('‚ö†Ô∏è Payment cancelled');
                    showError('Payment was cancelled. You can try again.');
                }
            }
        });

        // Hide loading status and show widget
        statusContainer.style.display = 'none';
        widgetContainer.style.display = 'block';

        console.log('‚úÖ SumUp widget mounted successfully');

    } catch (error) {
        console.error('‚ùå Error mounting SumUp widget:', error);
        showError('Failed to load payment form: ' + error.message);
    }
    {% else %}
    console.error('‚ùå No checkout ID provided');
    showError('Payment session not found. Please try again.');
    {% endif %}

    function showError(message) {
        statusContainer.style.display = 'none';
        widgetContainer.style.display = 'none';
        errorContainer.style.display = 'block';
        errorContainer.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle me-2"></i>' + message + '</div>';
    }

    function showSuccess(message) {
        statusContainer.style.display = 'none';
        errorContainer.innerHTML = '<div class="success-message"><i class="fas fa-check-circle me-2"></i>' + message + '</div>';
        errorContainer.style.display = 'block';
    }
});

// Debug: Log all console messages
console.log('üîç Widget template loaded');
console.log('üîç Checkout ID:', '{{ checkout_id|default:"None" }}');
console.log('üîç Order:', '{{ order.order_number|default:"None" }}');
</script>
{% endblock %}