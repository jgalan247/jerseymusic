{% extends "base.html" %}
{% load static %}

{% block title %}Analytics Dashboard - SumUp Connection Monitoring{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
<style>
.analytics-widget {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.widget-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.widget-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #374151;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
}

.metric-change {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.metric-change.positive {
    color: #059669;
}

.metric-change.negative {
    color: #dc2626;
}

.chart-container {
    position: relative;
    height: 400px;
    margin-top: 1rem;
}

.funnel-stage {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: #f9fafb;
    border-radius: 6px;
    border-left: 4px solid #3b82f6;
}

.alert-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
}

.alert-critical {
    background: #fef2f2;
    border-left: 4px solid #dc2626;
}

.alert-warning {
    background: #fffbeb;
    border-left: 4px solid #f59e0b;
}

.alert-info {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
}

.artist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: #f9fafb;
    border-radius: 6px;
}

.btn-remind {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 0.375rem 0.75rem;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
}

.btn-remind:hover {
    background: #2563eb;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">SumUp Connection Analytics</h1>
        </div>
    </div>

    <!-- Connection Metrics Widgets -->
    <div class="row">
        <div class="col-md-3">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Total Artists</h3>
                </div>
                <div class="metric-value" id="total-artists">{{ current_metrics.total_artists|default:0 }}</div>
                <div class="metric-change" id="total-artists-change"></div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Connected Artists</h3>
                </div>
                <div class="metric-value" id="connected-artists">{{ current_metrics.connected_artists|default:0 }}</div>
                <div class="metric-change" id="connected-artists-change"></div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Connection Rate</h3>
                </div>
                <div class="metric-value" id="connection-rate">{{ current_metrics.connection_rate|default:0 }}%</div>
                <div class="metric-change" id="connection-rate-change"></div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Not Connected</h3>
                </div>
                <div class="metric-value" id="not-connected">{{ current_metrics.not_connected|default:0 }}</div>
                <div class="metric-change" id="not-connected-change"></div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-md-8">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Daily Connection Metrics (30 Days)</h3>
                </div>
                <div class="chart-container">
                    <canvas id="dailyMetricsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Conversion Funnel</h3>
                    <a href="{% url 'analytics:funnel' %}" class="btn btn-sm btn-outline-primary">View Details</a>
                </div>
                <div class="funnel-stages">
                    {% for stage, data in funnel_data.items %}
                    <div class="funnel-stage">
                        <span>{{ data.label }}</span>
                        <span class="fw-bold">{{ data.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts and Artists Row -->
    <div class="row">
        <div class="col-md-6">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Recent Alerts</h3>
                    <a href="{% url 'analytics:alerts' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                {% if recent_alerts %}
                    {% for alert in recent_alerts %}
                    <div class="alert-item alert-{{ alert.severity }}">
                        <div>
                            <div class="fw-bold">{{ alert.get_alert_type_display }}</div>
                            <div class="text-muted small">{{ alert.message }}</div>
                        </div>
                        <div class="text-muted small">
                            {{ alert.triggered_at|timesince }} ago
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No recent alerts</p>
                {% endif %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Artists Need Connection</h3>
                    <a href="{% url 'analytics:artists_need_connection' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                {% if artists_need_connection %}
                    {% for artist in artists_need_connection %}
                    <div class="artist-item">
                        <div>
                            <div class="fw-bold">{{ artist.display_name }}</div>
                            <div class="text-muted small">{{ artist.user.email }}</div>
                        </div>
                        <button class="btn-remind" onclick="sendReminder({{ artist.id }})">
                            Send Reminder
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">All artists are connected!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-widget">
                <div class="widget-header">
                    <h3 class="widget-title">Quick Actions</h3>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'analytics:email_campaigns' %}" class="btn btn-outline-primary">Email Campaigns</a>
                    <a href="{% url 'analytics:weekly_reports' %}" class="btn btn-outline-primary">Weekly Reports</a>
                    <button onclick="generateWeeklyReport()" class="btn btn-primary">Generate Report</button>
                    <button onclick="refreshMetrics()" class="btn btn-outline-secondary">Refresh Data</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
// Chart configuration
const chartData = {{ chart_data|safe }};
const ctx = document.getElementById('dailyMetricsChart').getContext('2d');

const dailyMetricsChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Connected Artists',
            data: chartData.connected_artists,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1
        }, {
            label: 'Total Artists',
            data: chartData.total_artists,
            borderColor: '#6b7280',
            backgroundColor: 'rgba(107, 114, 128, 0.1)',
            tension: 0.1
        }, {
            label: 'Connection Rate (%)',
            data: chartData.connection_rates,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.1,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of Artists'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                min: 0,
                max: 100,
                title: {
                    display: true,
                    text: 'Connection Rate (%)'
                },
                grid: {
                    drawOnChartArea: false
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            title: {
                display: true,
                text: 'SumUp Connection Metrics Over Time'
            }
        }
    }
});

// Auto-refresh widgets
function refreshMetrics() {
    fetch('{% url "analytics:widgets_api" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-artists').textContent = data.total_artists;
            document.getElementById('connected-artists').textContent = data.connected_artists;
            document.getElementById('connection-rate').textContent = data.connection_rate + '%';
            document.getElementById('not-connected').textContent = data.not_connected;

            // Update change indicators
            updateChangeIndicator('total-artists-change', data.weekly_change_total || 0);
            updateChangeIndicator('connected-artists-change', data.daily_change || 0);
            updateChangeIndicator('connection-rate-change', data.weekly_change || 0);
            updateChangeIndicator('not-connected-change', -(data.daily_change || 0));
        })
        .catch(error => console.error('Error refreshing metrics:', error));
}

function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    const isPositive = change > 0;
    element.className = 'metric-change ' + (isPositive ? 'positive' : 'negative');
    element.textContent = (isPositive ? '+' : '') + change + ' this week';
}

// Send reminder email
function sendReminder(artistId) {
    const formData = new FormData();
    formData.append('artist_ids', artistId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "analytics:send_reminders_api" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Reminder email sent successfully!');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error sending reminder:', error);
        alert('Error sending reminder email');
    });
}

// Generate weekly report
function generateWeeklyReport() {
    fetch('{% url "analytics:generate_report_api" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Weekly report generated successfully!');
            window.location.href = '{% url "analytics:weekly_reports" %}';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error generating report:', error);
        alert('Error generating weekly report');
    });
}

// Auto-refresh every 5 minutes
setInterval(refreshMetrics, 5 * 60 * 1000);

// Initial load of change indicators
refreshMetrics();
</script>
{% endblock %}